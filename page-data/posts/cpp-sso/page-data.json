{
    "componentChunkName": "component---node-modules-gatsby-theme-academic-src-templates-post-post-jsx",
    "path": "/posts/cpp-sso",
    "result": {"data":{"mdx":{"timeToRead":1,"tableOfContents":{"items":[{"url":"#implementation-of-stdstring","title":"Implementation of std::string","items":[{"url":"#g","title":"g++"},{"url":"#llvmclang","title":"llvm/clang"}]}]},"frontmatter":{"cover":null},"fileAbsolutePath":"/home/runner/work/tc-imba.github.io/tc-imba.github.io/content/posts/2020-10-04-cpp-sso/index.md","fields":{"slug":{"html":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"C++ Small String Optimization\",\n  \"tags\": [\"cpp\"],\n  \"date\": \"2020-10-04T00:00:00.000Z\",\n  \"path\": \"posts/cpp-sso\",\n  \"excerpt\": \"In this post, SSO (small string optimization) in C++ is studied and some more efforts for small static strings are made.\"\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h2\", {\n    \"id\": \"implementation-of-stdstring\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#implementation-of-stdstring\",\n    \"aria-label\": \"implementation of stdstring permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Implementation of \", mdx(\"inlineCode\", {\n    parentName: \"h2\"\n  }, \"std::string\")), mdx(\"h3\", {\n    \"id\": \"g\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h3\",\n    \"href\": \"#g\",\n    \"aria-label\": \"g permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), mdx(\"inlineCode\", {\n    parentName: \"h3\"\n  }, \"g++\")), mdx(\"p\", null, \"In \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"g++\"), \" (libstdc++) implementation, Assuming a 64-bit OS, the class structure (with the size of each attribute) can be simplified as:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"hljs language-cpp\"\n  }, mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-keyword\"\n  }, \"template\"), \"<\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-keyword\"\n  }, \"typename\"), \" value_type>\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-class\"\n  }, mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-keyword\"\n  }, \"class\"), \" \", mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-title\"\n  }, \"basic_string\"), \" {\"), \"\\n    \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-class\"\n  }, mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-keyword\"\n  }, \"enum\"), \" {\"), \" __min_cap = \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-number\"\n  }, \"15\"), \" / \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-built_in\"\n  }, mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-keyword\"\n  }, \"sizeof\")), \"(value_type) };\\n\\n    pointer   __data_;                     \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"//  8 bytes\"), \"\\n    size_type __size_;                     \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"//  8 bytes\"), \"\\n\\n    \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-class\"\n  }, mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-keyword\"\n  }, \"union\"), \" {\"), \"\\n        value_type __data_[__min_cap + \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-number\"\n  }, \"1\"), \"]; \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"// 16 bytes\"), \"\\n        size_type  __cap_;                 \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"//  8 bytes\"), \"\\n    } __u_;                                \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"// 16 bytes\"), \"\\n};                                         \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"// 32 bytes\"))), mdx(\"p\", null, \"The capacity (\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"size_type\"), \", 8 bytes) is combined with a char array in a union if the string length is less than local capacity.\"), mdx(\"p\", null, \"The template argument \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"value_type\"), \" is define to support both \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"char\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"wchar_t\"), \".\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"basic_string<char>\"), \" has a local capacity of 15.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"basic_string<wchar_t>\"), \" has a local capacity of 7.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"we need one more char to store \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"\\\\0\"), \".\")), mdx(\"br\", null), mdx(\"p\", null, \"Both of them have a total size of 32 bytes. The size of the char array is 16 bytes, because in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"g++\"), \", a minimum block allocated by dynamic memory allocation (malloc/new) is 16 bytes (so less than 16 bytes is not a good optimization).\"), mdx(\"p\", null, \"You may notice that there exists an overhead of 8 bytes in the union. This is ignorable if you do not need to store huge amounts of small strings in memory.\"), mdx(\"h3\", {\n    \"id\": \"llvmclang\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h3\",\n    \"href\": \"#llvmclang\",\n    \"aria-label\": \"llvmclang permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), mdx(\"inlineCode\", {\n    parentName: \"h3\"\n  }, \"llvm/clang\")), mdx(\"p\", null, \"In \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"llvm/clang\"), \" (libc++) implementation, the overhead can be cancelled by a smarter design: using the entire structure to store the small string.\"), mdx(\"p\", null, \"We define two modes for each string: long string mode and short string mode, each in a separate struct, and then combine them together with a union.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"hljs language-cpp\"\n  }, mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-keyword\"\n  }, \"template\"), \"<\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-keyword\"\n  }, \"typename\"), \" value_type>\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-class\"\n  }, mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-keyword\"\n  }, \"class\"), \" \", mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-title\"\n  }, \"basic_string\"), \" {\"), \"\\n    \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-class\"\n  }, mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-keyword\"\n  }, \"struct\"), \" __\", mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-title\"\n  }, \"long\"), \" {\"), \"\\n        size_type __cap_;               \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"// 8      bytes\"), \"\\n        size_type __size_;              \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"// 8      bytes\"), \"\\n        pointer   __data_;              \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"// 8      bytes\"), \"\\n    };\\n\\n    \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-class\"\n  }, mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-keyword\"\n  }, \"enum\"), \" {\"), \"__min_cap = (\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-built_in\"\n  }, mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-keyword\"\n  }, \"sizeof\")), \"(__long) - \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-number\"\n  }, \"1\"), \") / \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-built_in\"\n  }, mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-keyword\"\n  }, \"sizeof\")), \"(value_type) > \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-number\"\n  }, \"2\"), \" ?\\n                      (\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-built_in\"\n  }, mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-keyword\"\n  }, \"sizeof\")), \"(__long) - \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-number\"\n  }, \"1\"), \") / \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-built_in\"\n  }, mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-keyword\"\n  }, \"sizeof\")), \"(value_type) : \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-number\"\n  }, \"2\"), \"};\\n\\n    \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-class\"\n  }, mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-keyword\"\n  }, \"struct\"), \" __\", mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-title\"\n  }, \"short\"), \" {\"), \"\\n        \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-class\"\n  }, mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-keyword\"\n  }, \"union\"), \" {\"), \"\\n            \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-keyword\"\n  }, \"unsigned\"), \" \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-keyword\"\n  }, \"char\"), \" __size_;      \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"// 1      byte\"), \"\\n            value_type __lx;            \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"// 1 (2)  bytes for char(wchar_t)\"), \"\\n        };                              \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"// 1 (2)  bytes for char(wchar_t)\"), \"\\n        value_type __data_[__min_cap];  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"// 23(22) bytes for char(wchar_t)\"), \"\\n    };                                  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"// 24     bytes\"), \"\\n\\n    \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-class\"\n  }, mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"hljs-keyword\"\n  }, \"union\"), \" {\"), \"\\n        __long  __l;                    \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"// 24     bytes\"), \"\\n        __short __s;                    \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"// 24     bytes\"), \"\\n    } __r_;                             \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"hljs-comment\"\n  }, \"// 24     bytes\"), \"\\n}\\n\")), mdx(\"p\", null, \"In short string mode, the first byte of the string stores the size (which is less than 24). The rest bytes store the string locally. The variable \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"__lx\"), \" is used for alignment with \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"wchar_t\"), \".\"), mdx(\"p\", null, \"In order to distinguish a long string from a short one, the first byte of a long string (also the first byte of its capacity) is set to a mask 0x80 (which is larger than the maximum length of short string). This mask actually half the maximum capacity of the long string, but 0x 7fff ffff ffff ffff is huge enough comparing to achievable memory size.\"), mdx(\"p\", null, \"This design eliminates the size of a string to 24 bytes, and provides a longer local string (15 -> 22 for \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"char\"), \", or 7 -> 10 for \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"wchar_t\"), \").\"));\n}\n;\nMDXContent.isMDXComponent = true;","htmlEncrypted":"","nonce":"","title":"C++ Small String Optimization","date":"2020-10-04T00:00:00.000Z","tags":["cpp"],"path":"posts/cpp-sso","excerpt":"In this post, SSO (small string optimization) in C++ is studied and some more efforts for small static strings are made.","links":[],"commit":1645648952,"type":"posts"}}}},"pageContext":{"fileAbsolutePath":"/home/runner/work/tc-imba.github.io/tc-imba.github.io/content/posts/2020-10-04-cpp-sso/index.md","postPath":"posts/cpp-sso","translations":[{"hreflang":"en","path":"/posts/cpp-sso"}]}},
    "staticQueryHashes": ["1552981879","3013679938","4097791827"]}